#!/bin/bash
#
# shell for gnuplot
#
#########################################################

version=1.50

# 1.50	05.05.2011	new option -sy (not yet working)
# 1.46	23.10.2009	new option -verbose
# 1.45	24.08.2009	new option -bw (is already default)
# 1.44	20.08.2009	better handling of -png option
# 1.43	04.02.2002	accepts -o option
# 1.42	30.01.2002	accepts -xtics option
# 1.41	30.11.2001	accepts -style option special -> small red box
# 1.40	29.11.2001	accepts -style option
# 1.31			accepts -grid
# 1.30			accepts -ppp and -sx
# 1.23			accepts -u all
# 1.22			remove parts of legend (option -l)
# 1.21			better conti line treatment, signal error in option
# 1.20			specify x/y range
# 1.10			using different columns
# 1.00			original version

######################################################### defaults

femdir=${SHYFEMDIR:=$HOME/shyfem}

title="Timeseries"
type="monochrome"
orientation="landscape"
terminal="postscript"
using="using 1:2"
grid="NO"
verbose="NO"
nolegend="xyz*^+="	# something very unlikely
ppp="0"			# plots per page
xfact="1"		# scaling of x axis
yfact="1"		# scaling of y axis
style=""
xtics=""
outfile=""
ghost='ghostview -dsc -scale -2'

######################################################### programs

psgnu="psgnu"
gnuplot="gnuplot"
extractcol="extractcol"
scalecol="scalecol"
range="range"
gpsmerge="gpsmerge"

######################################################### copyright

copy1="File automatically generated by gp"
copy2="gp - shell for gnuplot                 Version $version"
copy3="Copyright (c) 1998-2002 Georg Umgiesser - ISDGM/CNR"
copy4="e-mail: georg@isdgm.ve.cnr.it"

######################################################### help - usage

Copy()
{
  echo "$copy2"
  echo "$copy3"
}

Usage()
{
  echo "Usage: gp [ -h | -help ] [ options ] file[s]"
}

FullUsage()
{
  echo ""

  Copy
  echo ""
  Usage

  echo ""
  echo "Available options:"
  echo "  -h|-help         this help"
  echo "  -c|-bw           color|black&white output (-bw is default)"
  echo "  -o outfile       plot to outfile (show with ghostview if -)"
  echo "  -png             output in PNG format"
  echo "  -p               portrait mode"
  echo "  -ppp n           put n plots per page (default: all plots)"
  echo "  -grid            plots grid underneath plot"
  echo "  -style style     sets line style for following files"
  echo "  -xtics xtics     sets tics style for x-axis"
  echo "  -u  x:y          using columns x and y for x/y values (Default 1:2)"
  echo "  -u  all          plot all columns"
  echo "  -t  title        give title of plot"
  echo "  -tx xlabel       give x-label of plot"
  echo "  -ty ylabel       give y-label of plot"
  echo "  -rx xmin:xmax    give x-range of plot"
  echo "  -ry ymin:ymax    give y-range of plot"
  echo "  -sx xfact        scale x-coordinate with xfact"
  echo "  -sy yfact        scale y-coordinate with yfact"
  echo "  -l  string       string that is removed from legend if found"
  echo "  -verbose         writes some diagnostic messages"
  echo ""
  echo "Possible style options are:"
  echo "   lines, points, linespoints, impulses, dots"
  echo "   steps, fsteps, histeps"
  echo "   errorbars, xerrorbars, yerrorbars"
  echo "Possible xtics options are:"
  echo "   xdtics, xmtics, mesi, months or (custom)"
  echo ""
}

ErrorOption()
{
  echo "No such option : $1"
}

ErrorOptionPosition()
{
  echo "No such option or in wrong place: $1"
}

MakeLegend()	#substitutes _ with blank and removes string in $nolegend
{
  echo $1 | sed -e "s/$nolegend//g" | sed -e 's/_/ /g' | sed -e 's/ *$//'
}

#-------------------------------------------------------------------

GiveNames()
{
  newfiles=""

  for file in $files
  do
    line=`head -1 $file | perl -p -e 's/\s*\S+\s+//'`
    newfile=`echo $line | grep '^[a-zA-Z]'`
    if [ -n "$newfile" ]; then
      #echo "filename is $newfile"
      newfiles="$newfiles $newfile"
      mv -f $file $newfile
    else
      newfiles="$newfiles $file"
    fi
  done

  files=$newfiles
}

SetFilesAndAttributes()
{
  # with one arg -> append to array, else make new array

  if [ $# -eq 0 ]; then
    true
  elif [ $# -eq 1 ]; then
    n=${#afiles[@]}
    astyles[$n]=$style
    afiles[$n]=$1
  else
    n=0
    for file
    do
      astyles[$n]=$style
      afiles[$n]=$file
      ((n++))
    done
  fi
}

MakeFiles()
{
  while [ -n "$1" ]
  do
     case $1 in
	  -style)	style=$2; shift;;
	  -*)		ErrorOptionPosition $1; exit 1;;
	  *)		SetFilesAndAttributes $1;;
     esac
     shift
  done
}

ShowFiles()
{
  n=${#afiles[@]}
  m=0

  while [ $m -lt $n ]
  do
     echo "${afiles[$m]}  ${astyles[$m]}   $m / $n"
     ((m++))
  done
}

#-------------------------------------------------------------------

Plotting()
{
  echo 'plot \' >> gnu.tmp

   eol=' \'	#end of line
  cont='  '	#continuation of line

  while [ $# -gt 0 ]
  do

    file=${afiles[$1]}
    style=${astyles[$1]}

    with=""
    use=$using
    if [ -n "$style" ]; then
      with="w $style"
      if [ $style = "special" ]; then
        with="w points pt 4"
        special="1"
      elif [ $style = "special2" ]; then
        with="w xerrorbars"
        use="using 1:2:3"
        special="2"
      elif [ $style = "xerrorbars" ]; then
        use="using 1:2:3"
      elif [ $style = "yerrorbars" ]; then
        use="using 1:2:3"
      elif [ $style = "errorbars" ]; then
        use="using 1:2:3"
      fi
    fi

    [ -z "$2" ] && eol=' '

    legend=`MakeLegend $file`
    line="     \"$file\" $use title \"$legend\" $with "
    echo "$cont $line $eol" >> gnu.tmp
    cont=', '

    shift

  done

  echo "" >> gnu.tmp
  echo "quit" >>  gnu.tmp
}

PlotFiles()
{
  cp gnu.tmp gnuhead.tmp
  rm -f out.[1-9]*.ps

  nfiles=${#afiles[@]}

  [ $ppp -eq 0 ] && ppp=$nfiles		#all plots on one page

  page=0
  index=0

  while [ $index -lt $nfiles ]
  do
    ((page++))
    fnames=""
    indices=""
    special="NO"

    for f in `$range $ppp`
    do
      file=${afiles[$index]}
      fnames="$fnames $file"
      indices="$indices $index"
      ((index++))
      shift
    done

    if [ $verbose = "YES" ]; then
      echo "page: $page  files: $fnames  indices: $indices"
    fi
    cp gnuhead.tmp gnu.tmp

    Plotting $indices
    $gnuplot gnu.tmp
    [ $orientation = "landscape" ] && $psgnu out.ps
    [ $special != "NO" ] && AdjustSpecial $special

    [ -f out.ps ] && mv out.ps out.$page.ps
  done
  [ -f out.1.ps ] && $gpsmerge out.[1-9]*.ps > out.ps
}

#-------------------------------------------------------------------

mesi='\
         ""  0 , "Gen"  0.5 , ""  1 , "Feb"  1.5 , \
         ""  2 , "Mar"  2.5 , ""  3 , "Apr"  3.5 , \
         ""  4 , "Mag"  4.5 , ""  5 , "Giu"  5.5 , \
         ""  6 , "Lug"  6.5 , ""  7 , "Ago"  7.5 , \
         ""  8 , "Set"  8.5 , ""  9 , "Ott"  9.5 , \
         "" 10 , "Nov" 10.5 , "" 11 , "Dic" 11.5 , \
         "" 12'

months='\
         ""  0 , "Jan"  0.5 , ""  1 , "Feb"  1.5 , \
         ""  2 , "Mar"  2.5 , ""  3 , "Apr"  3.5 , \
         ""  4 , "May"  4.5 , ""  5 , "Jun"  5.5 , \
         ""  6 , "Jul"  6.5 , ""  7 , "Aug"  7.5 , \
         ""  8 , "Sep"  8.5 , ""  9 , "Oct"  9.5 , \
         "" 10 , "Nov" 10.5 , "" 11 , "Dec" 11.5 , \
         "" 12'

#-------------------------------------------------------------------

AdjustSpecial()
{
  #for some reason special must always be last option -> color problems
  laststyle=`grep '^LT' out.ps | tail -1`
  echo "adjusting special style: $laststyle"
  gpgnustyle.pl $1 out.ps > out.tmp
  mv out.tmp out.ps
}

#-------------------------------------------------------------------

######################################################### read options

while [ -n "$1" ]
do
   case $1 in
	-c)		type="color";;
	-bw)		type="monochrome";;
	-o)		outfile=$2; shift;;
	-p)		orientation="portrait";;
	-ppp)		ppp=$2; shift;;
	-grid)		grid="YES";;
	-xtics)		xtics=$2; shift;;
	-style)		style=$2; shift;;
	-png)		terminal="png";;
	-u)		using="using $2"; shift;;
	-t)		title=$2; shift;;
	-tx)		xlabel=$2; shift;;
	-ty)		ylabel=$2; shift;;
	-rx)		xrange=$2; shift;;
	-ry)		yrange=$2; shift;;
	-sx)		xfact=$2; shift;;
	-sy)		yfact=$2; shift;;
	-l)		nolegend=$2; shift;;
	-verbose)	verbose="YES";;
	-h|-help)	FullUsage; exit 0;;
	-*)		ErrorOption $1; exit 1;;
	*)		break;;
   esac
   shift
done

######################################################### no file -> write help

if [ $# -le 0 ]; then
  Usage
  exit 1;
fi

######################################################### write header

if [ $terminal = "png" ]; then
  orientation="small"
  orientation="large"
  output="out.png"
  type="size 1280,960"
  type="size 800,600"
else
  output="out.ps"
fi

cat > gnu.tmp <<EOI

# $copy1
# $copy2
# $copy3
# $copy4

set terminal $terminal $orientation $type
set output "$output"

set style data lines
#set data style lines		#old call
#set data style linespoints
set title "$title"

EOI

######################################################### write defaults

if [ -n "$xlabel" ]; then
  echo "set xlabel \"$xlabel\"" >> gnu.tmp
fi
if [ -n "$ylabel" ]; then
  echo "set ylabel \"$ylabel\"" >> gnu.tmp
fi

if [ -n "$xrange" ]; then
  echo "set xrange [$xrange]" >> gnu.tmp
fi
if [ -n "$yrange" ]; then
  echo "set yrange [$yrange]" >> gnu.tmp
fi

if [ $orientation = "portrait" ]; then
  echo "set size 0.7,0.7" >> gnu.tmp
fi

if [ $grid = "YES" ]; then
  echo "set grid" >> gnu.tmp
fi

if [ -n "$xtics" ]; then
  if [ "$xtics" = "xdtics" ]; then
    echo "set xdtics" >> gnu.tmp
  elif [ "$xtics" = "xmtics" ]; then
    echo "set xmtics" >> gnu.tmp
  elif [ "$xtics" = "mesi" ]; then
    echo "set xtics ($mesi)" >> gnu.tmp
  elif [ "$xtics" = "months" ]; then
    echo "set xtics ($months)" >> gnu.tmp
  else
    echo "set xtics $xtics" >> gnu.tmp
  fi
fi

echo "" >> gnu.tmp

######################################################### files to plot

declare -a afiles		#must be global (how else?)
declare -a astyles

MakeFiles $@

files=${afiles[@]}

######################################################### adjust using command

if [ "$using" = "using all" ]; then
  using="using 1:2"
  nfiles=${#afiles[@]}
  if [ $nfiles -gt 1 ]; then
    echo "-u all only with one file"
    exit 1
  fi
  rm -f column.*
  $extractcol -f column $files
  files=`ls column.*[0-9]`
  GiveNames
  SetFilesAndAttributes $files
  deletefiles=$files
fi

######################################################### scale plot

if [ $xfact != "1" ]; then
  newfiles=""
  m=0
  while [ $m -lt ${#afiles[@]} ]
  do
    file=${afiles[$m]}
    newfile=${file}_
    $scalecol -s $xfact $file > $newfile
    afiles[$m]=$newfile
    ((m++))
  done
  files=${afiles[@]}
fi

#ShowFiles

######################################################### 

PlotFiles 

######################################################### 

#echo "outfile: $outfile"
if [ -n "$outfile" ]; then
  if [ "$outfile" = "-" ]; then
    $ghost out.ps
  elif [ "$outfile" = "out.png" ]; then
    :
  else
    rename out. $outfile. out.[1-9]*.ps out.ps
  fi
fi

#echo "files to be deleted:"
#echo "$deletefiles"
rm -f $deletefiles

######################################################### end

